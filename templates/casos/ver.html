{% extends "base.html" %}
{% block title %}Caso #{{ caso.id }} - RedProtege{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto my-8 px-4">

    {# --- CABECERA Y ESTADO --- #}
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div>
            <div class="flex items-center gap-3 flex-wrap">
                <h1 class="text-3xl font-bold text-gray-800">
                    Caso #{{ caso.folio_atencion if caso.folio_atencion else caso.id }}
                </h1>

                <span class="px-3 py-1 rounded-full text-sm font-bold
                    {% if caso.estado == 'PENDIENTE_RESCATAR' %}bg-yellow-100 text-yellow-800
                    {% elif caso.estado == 'EN_SEGUIMIENTO' %}bg-blue-100 text-blue-800
                    {% else %}bg-green-100 text-green-800{% endif %}">
                    {% if caso.estado == 'PENDIENTE_RESCATAR' %}Pendiente rescatar
                    {% elif caso.estado == 'EN_SEGUIMIENTO' %}En seguimiento
                    {% else %}Cerrado{% endif %}
                </span>

                {% if caso.asignado_a %}
                    <span class="px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-800">
                        Asignado: {{ caso.asignado_a.nombre_completo }}
                    </span>
                {% else %}
                    <span class="px-3 py-1 rounded-full text-xs font-bold bg-gray-100 text-gray-700">
                        Sin asignar
                    </span>
                {% endif %}
            </div>

            <p class="text-gray-500 mt-1">
                Ingresado el
                <strong>{{ caso.fecha_ingreso.strftime('%d/%m/%Y %H:%M') if caso.fecha_ingreso else '-' }}</strong>
                {% if caso.ingresado_por_nombre %}
                    por <strong>{{ caso.ingresado_por_nombre }}</strong>
                {% endif %}
            </p>
        </div>

        <a href="{{ url_for('casos.index') }}" class="btn btn-secondary">Volver a la Bandeja</a>
    </div>

    {# --- BLOQUE DE ASIGNACIÓN (Solo Admin/Referente) --- #}
    {% if current_user.rol and current_user.rol.nombre in ['Admin', 'Referente'] and caso.estado != 'CERRADO' %}
    <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-8 shadow-sm">
        <h3 class="text-lg font-bold text-blue-800 mb-4 flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z">
                </path>
            </svg>
            Asignación de Profesional
        </h3>

        <form method="post" class="flex flex-col md:flex-row gap-4 items-end">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="asignar_funcionario" value="1"/>

            <div class="w-full md:w-1/2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Funcionario Encargado</label>
                <select name="funcionario_id" class="w-full rounded-lg border-gray-300" required>
                    <option value="">Seleccione Funcionario...</option>
                    {% for f in funcionarios %}
                        <option value="{{ f.id }}" {% if caso.asignado_a_usuario_id == f.id %}selected{% endif %}>
                            {{ f.nombre_completo }}
                        </option>
                    {% endfor %}
                </select>
                <p class="text-xs text-gray-500 mt-1">
                    Solo se listan funcionarios activos y compatibles con el ciclo.
                </p>
            </div>

            <button type="submit" class="btn btn-primary">
                {{ 'Reasignar' if caso.asignado_a_usuario_id else 'Asignar Caso' }}
            </button>
        </form>

        {% if caso.asignado_a and caso.asignado_por and caso.asignado_at %}
            <p class="text-xs text-blue-700 mt-3">
                Actualmente asignado a: <strong>{{ caso.asignado_a.nombre_completo }}</strong>
                (por <strong>{{ caso.asignado_por.nombre_completo }}</strong>
                el <strong>{{ caso.asignado_at.strftime('%d/%m %H:%M') }}</strong>)
            </p>
        {% elif caso.asignado_a %}
            <p class="text-xs text-blue-700 mt-3">
                Actualmente asignado a: <strong>{{ caso.asignado_a.nombre_completo }}</strong>
            </p>
        {% endif %}
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        {# --- COLUMNA IZQUIERDA: DATOS INMUTABLES --- #}
        <div class="lg:col-span-2 space-y-6">

            {# --- PACIENTE --- #}
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-green-500">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Datos del Paciente (Inmutables)</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="block text-gray-500 text-xs">Nombre Completo</span>
                        <span class="font-medium text-gray-900">
                            {% if caso.origen_nombres or caso.origen_apellidos %}
                                {{ caso.origen_nombres if caso.origen_nombres else '' }}
                                {{ caso.origen_apellidos if caso.origen_apellidos else '' }}
                            {% else %}
                                <span class="text-gray-400 italic">(Pendiente)</span>
                            {% endif %}
                        </span>
                    </div>

                    <div>
                        <span class="block text-gray-500 text-xs">Identificación</span>
                        <span class="font-medium text-gray-900">
                            {% if caso.paciente_doc_tipo and caso.paciente_doc_numero %}
                                {{ caso.paciente_doc_tipo }}: {{ caso.paciente_doc_numero }}
                                {% if caso.paciente_doc_tipo == 'OTRO' and caso.paciente_doc_otro_descripcion %}
                                    <span class="text-gray-500 text-xs">({{ caso.paciente_doc_otro_descripcion }})</span>
                                {% endif %}
                            {% elif caso.origen_rut %}
                                RUT: {{ caso.origen_rut }}
                            {% else %}
                                <span class="text-gray-400 italic">No informada</span>
                            {% endif %}
                        </span>
                    </div>

                    <div>
                        <span class="block text-gray-500 text-xs">Fecha Nacimiento</span>
                        <span class="font-medium text-gray-900">
                            {{ caso.paciente_fecha_nacimiento.strftime('%d-%m-%Y') if caso.paciente_fecha_nacimiento else 'No informada' }}
                        </span>
                    </div>

                    <div>
                        <span class="block text-gray-500 text-xs">Ciclo Vital</span>
                        <span class="font-medium text-gray-900">
                            {{ caso.ciclo_vital.nombre if caso.ciclo_vital else '-' }}
                        </span>
                    </div>

                    <div class="md:col-span-2">
                        <span class="block text-gray-500 text-xs">Domicilio</span>
                        <span class="font-medium text-gray-900">
                            {% if caso.paciente_direccion_calle %}
                                {{ caso.paciente_direccion_calle }}
                                {% if caso.paciente_direccion_numero %} #{{ caso.paciente_direccion_numero }}{% endif %}
                            {% else %}
                                {{ caso.paciente_domicilio if caso.paciente_domicilio else '-' }}
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            {# --- RELATO + VULNERACIONES --- #}
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-gray-500">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Relato del Caso (Inmutable)</h3>

                <div class="bg-gray-50 p-4 rounded-lg text-gray-700 text-sm italic">
                    "{{ caso.origen_relato if caso.origen_relato else '' }}"
                </div>

                <div class="mt-4">
                    <span class="block text-gray-500 text-xs mb-1">Vulneraciones reportadas:</span>

                    <div class="flex flex-wrap gap-2">
                        {% for v in caso.vulneraciones %}
                            <span class="px-2 py-1 bg-red-100 text-red-800 text-xs rounded-md font-bold">
                                {{ v.nombre }}
                            </span>
                        {% endfor %}

                        {% if caso.vulneracion_otro_texto %}
                            <span class="px-2 py-1 bg-red-50 text-red-800 text-xs rounded-md font-bold">
                                Otro: {{ caso.vulneracion_otro_texto }}
                            </span>
                        {% endif %}

                        {% if (caso.vulneraciones|length == 0) and not caso.vulneracion_otro_texto %}
                            <span class="text-gray-400 text-xs italic">No informadas</span>
                        {% endif %}
                    </div>
                </div>
            </div>

            {# --- ACOMPAÑANTE (COMPLETO) --- #}
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-yellow-500">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Datos del Acompañante (Inmutables)</h3>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="block text-gray-500 text-xs">Nombre</span>
                        <span class="font-medium text-gray-900">
                            {{ caso.acompanante_nombre if caso.acompanante_nombre else '-' }}
                        </span>
                    </div>

                    <div>
                        <span class="block text-gray-500 text-xs">Parentesco</span>
                        <span class="font-medium text-gray-900">
                            {{ caso.acompanante_parentesco if caso.acompanante_parentesco else '-' }}
                        </span>
                    </div>

                    <div>
                        <span class="block text-gray-500 text-xs">Teléfono</span>
                        <span class="font-medium text-gray-900">
                            {{ caso.acompanante_telefono if caso.acompanante_telefono else '-' }}
                            {% if caso.acompanante_telefono_tipo %}
                                <span class="text-gray-400 text-xs">({{ caso.acompanante_telefono_tipo }})</span>
                            {% endif %}
                        </span>
                    </div>

                    <div>
                        <span class="block text-gray-500 text-xs">Identificación</span>
                        <span class="font-medium text-gray-900">
                            {% if caso.acompanante_doc_tipo and caso.acompanante_doc_numero %}
                                {{ caso.acompanante_doc_tipo }}: {{ caso.acompanante_doc_numero }}
                                {% if caso.acompanante_doc_tipo == 'OTRO' and caso.acompanante_doc_otro_descripcion %}
                                    <span class="text-gray-500 text-xs">({{ caso.acompanante_doc_otro_descripcion }})</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-400 italic">No informada</span>
                            {% endif %}
                        </span>
                    </div>

                    <div class="md:col-span-2">
                        <span class="block text-gray-500 text-xs">Domicilio</span>
                        <span class="font-medium text-gray-900">
                            {% if caso.acompanante_direccion_calle %}
                                {{ caso.acompanante_direccion_calle }}
                                {% if caso.acompanante_direccion_numero %} #{{ caso.acompanante_direccion_numero }}{% endif %}
                            {% else %}
                                {{ caso.acompanante_domicilio if caso.acompanante_domicilio else '-' }}
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>

            {# --- DENUNCIA (COMPLETA) --- #}
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-red-600">
                <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Denuncia (Inmutable)</h3>

                <div class="text-sm">
                    <p>
                        <span class="text-gray-500 text-xs">¿Se realizó denuncia?</span><br>
                        <span class="font-medium text-gray-900">
                            {{ 'Sí' if caso.denuncia_realizada else 'No' }}
                        </span>
                    </p>

                    {% if caso.denuncia_realizada %}
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <span class="block text-gray-500 text-xs">Institución</span>
                                <span class="font-medium text-gray-900">
                                    {% if caso.denuncia_institucion %}
                                        {{ caso.denuncia_institucion.nombre }}
                                    {% else %}
                                        -
                                    {% endif %}
                                    {% if caso.denuncia_institucion_otro %}
                                        <span class="text-gray-500 text-xs">(Otro: {{ caso.denuncia_institucion_otro }})</span>
                                    {% endif %}
                                </span>
                            </div>

                            <div>
                                <span class="block text-gray-500 text-xs">Profesional</span>
                                <span class="font-medium text-gray-900">
                                    {{ caso.denuncia_profesional_nombre if caso.denuncia_profesional_nombre else '-' }}
                                    {% if caso.denuncia_profesional_cargo %}
                                        <span class="text-gray-500 text-xs">({{ caso.denuncia_profesional_cargo }})</span>
                                    {% endif %}
                                </span>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            {# --- GESTIÓN CLÍNICA REGISTRADA (LECTURA) --- #}

            {# Labels bonitos para ENUMs #}
            {% set labels = {
              'PENDIENTE_REVISION':'Pendiente por Revisar',
              'CITACION_1':'1° Citación',
              'CITACION_2':'2° Citación',
              'CITACION_3':'3° Citación',
              'AL_DIA':'Al Día',
              'PENDIENTE':'Pendiente',
              'INGRESADO':'Ingresado',
              'DERIVADO':'Derivado',
              'NO_CORRESPONDE':'No corresponde'
            } %}

            {# Condición: mostrar tarjeta si hay cualquier dato de gestión relevante #}
            {% set tiene_gestion =
                caso.recinto_inscrito_id
                or caso.ingreso_lain
                or caso.fallecido
                or caso.fecha_defuncion
                or caso.control_sanitario
                or caso.gestion_vacunas
                or caso.gestion_judicial
                or caso.gestion_salud_mental
                or caso.gestion_cosam
                or caso.observaciones_gestion
                or caso.recinto_inscrito_otro_texto
            %}

            {% if tiene_gestion %}
            <div class="bg-white p-6 rounded-xl shadow border-l-4 border-purple-600">
              <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Gestión Clínica Registrada</h3>

              <div class="text-sm space-y-3">
                {# Recinto + Texto Otro #}
                {% if caso.recinto_inscrito %}
                  <p>
                    <span class="font-bold">Recinto Inscrito:</span>
                    {{ caso.recinto_inscrito.nombre }}
                    {% if caso.recinto_inscrito_otro_texto %}
                      <span class="text-gray-600 italic">({{ caso.recinto_inscrito_otro_texto }})</span>
                    {% endif %}
                  </p>
                {% elif caso.recinto_inscrito_otro_texto %}
                  <p>
                    <span class="font-bold">Recinto Inscrito:</span>
                    <span class="text-gray-600 italic">{{ caso.recinto_inscrito_otro_texto }}</span>
                  </p>
                {% endif %}

                <div class="flex flex-wrap gap-2">
                  {% if caso.ingreso_lain %}
                    <span class="inline-block bg-purple-100 text-purple-800 text-xs font-bold px-2 py-1 rounded">
                      Ingreso LAIN
                    </span>
                  {% endif %}

                  {% if caso.fallecido %}
                    <span class="inline-block bg-black text-white text-xs font-bold px-2 py-1 rounded">
                      Fallecido{% if caso.fecha_defuncion %} ({{ caso.fecha_defuncion.strftime('%d-%m-%Y') }}){% endif %}
                    </span>
                  {% endif %}
                </div>

                {# Mostrar siempre los estados (aunque estén en pendiente) #}
                {% if caso.control_sanitario %}
                  <p><span class="font-bold">Controles:</span> {{ labels.get(caso.control_sanitario, caso.control_sanitario) }}</p>
                {% endif %}
                {% if caso.gestion_vacunas %}
                  <p><span class="font-bold">Vacunas:</span> {{ labels.get(caso.gestion_vacunas, caso.gestion_vacunas) }}</p>
                {% endif %}
                {% if caso.gestion_judicial %}
                  <p><span class="font-bold">Informe Judicial:</span> {{ labels.get(caso.gestion_judicial, caso.gestion_judicial) }}</p>
                {% endif %}
                {% if caso.gestion_salud_mental %}
                  <p><span class="font-bold">Salud Mental:</span> {{ labels.get(caso.gestion_salud_mental, caso.gestion_salud_mental) }}</p>
                {% endif %}
                {% if caso.gestion_cosam %}
                  <p><span class="font-bold">COSAM:</span> {{ labels.get(caso.gestion_cosam, caso.gestion_cosam) }}</p>
                {% endif %}

                {% if caso.observaciones_gestion %}
                  <div class="mt-2 p-3 bg-gray-50 rounded border border-gray-200">
                    <span class="block text-xs font-bold text-gray-500 mb-1">Observaciones y derivaciones:</span>
                    {{ caso.observaciones_gestion }}
                  </div>
                {% endif %}
              </div>
            </div>
            {% endif %}

        </div>

        {# --- COLUMNA DERECHA: GESTIÓN --- #}
        <div class="space-y-6">
            <div class="bg-white p-6 rounded-xl shadow border-t-4 border-blue-600">
                <h3 class="text-lg font-bold text-gray-800 mb-4">Gestión del Caso</h3>

                {% set rol = (current_user.rol.nombre if current_user.rol else '') %}
                {% set es_cerrado = (caso.estado == 'CERRADO') %}
                {% set puede_gestionar = (rol == 'Admin') or (rol == 'Funcionario' and caso.asignado_a_usuario_id == current_user.id) %}

                {% if es_cerrado %}
                    {# CASO CERRADO: Aviso y Descarga #}
                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-sm text-green-800 text-center mb-4">
                        <p><strong>Caso Cerrado</strong></p>
                        <p class="text-xs mt-1">Este caso ha sido finalizado y no admite más ediciones.</p>
                    </div>

                    {% if caso.acta_pdf_path %}
                        <div class="text-center">
                            <a href="{{ url_for('casos.descargar_acta', id=caso.id) }}" target="_blank" class="btn btn-secondary w-full flex items-center justify-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Descargar Acta de Cierre
                            </a>
                        </div>
                    {% endif %}

                {% elif puede_gestionar %}
                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-blue-800 mb-4">
                        Puedes gestionar este caso. Los datos del formulario son inmutables.
                    </div>

                    <div class="text-center">
                        <a href="{{ url_for('casos.gestionar_caso', id=caso.id) }}"
                           class="btn btn-primary w-full mb-2 flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                </path>
                            </svg>
                            Ingresar Gestión
                        </a>
                    </div>
                {% else %}
                    <div class="bg-yellow-50 p-4 rounded text-yellow-800 text-sm text-center">
                        <p>Este caso es de solo lectura para tu perfil.</p>
                        {% if rol == 'Funcionario' %}
                            <p class="mt-1 text-xs">Solo el funcionario asignado puede gestionarlo.</p>
                        {% endif %}
                    </div>
                {% endif %}

                <div class="mt-6 border-t pt-4">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">Historial (últimos movimientos)</h4>

                    {% set ultimos = caso.auditorias[-5:] if caso.auditorias else [] %}
                    {% if ultimos %}
                        <ul class="text-xs text-gray-500 space-y-2">
                            {% for audit in ultimos|reverse %}
                            <li class="border-b pb-1">
                                <span class="font-bold">{{ audit.accion }}</span>
                                {% if audit.usuario %}por {{ audit.usuario.nombre_completo }}{% endif %}
                                <br>
                                {{ audit.fecha_movimiento.strftime('%d/%m %H:%M') if audit.fecha_movimiento else '-' }}
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p class="text-xs text-gray-400 italic">Sin movimientos registrados.</p>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}